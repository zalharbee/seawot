!function(e,t,o){function a(t,o){this.element=t,s=e(t),this.options=e.extend({},m,o),this._defaults=m,this._name="WebCodeCam",this.init()&&(this.setEventListeners(),(this.options.ReadQRCode||this.options.ReadBarecode)&&this.setCallback())}var i,n,r,s,d,c,u={},l=e('<video style="position:absolute;visibility:hidden;display: none;">')[0],h=!1,p=!1,g=new Worker("js/DecoderWorker.js"),f=!1,m={ReadQRCode:!0,ReadBarecode:!0,width:320,height:240,videoSource:{id:!0,maxWidth:640,maxHeight:480},flipVertical:!1,flipHorizontal:!1,zoom:-1,beep:"https://rawgit.com/zalharbee/seawot/master/barcode/js/beep.mp3",brightness:0,autoBrightnessValue:!1,grayScale:!1,contrast:0,threshold:0,sharpness:[],resultFunction:function(){},getUserMediaError:function(){},cameraError:function(){}};a.prototype={init:function(){return i=this,r=i.element.getContext("2d"),d=i.options.width,c=i.options.height,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia?(u[i.options.videoSource.id]&&u[i.options.videoSource.id].active?i.cameraSuccess(u[i.options.videoSource.id]):navigator.getUserMedia({video:{mandatory:{maxWidth:i.options.videoSource.maxWidth,maxHeight:i.options.videoSource.maxHeight},optional:[{sourceId:i.options.videoSource.id}]},audio:!1},i.cameraSuccess,i.cameraError),!0):(i.options.getUserMediaError(),!1)},cameraSuccess:function(e){u[i.options.videoSource.id]=e;var o=t.URL||t.webkitURL;l.src=o?o.createObjectURL(e):e,l.play()},cameraError:function(e){return i.options.cameraError(e),!1},setEventListeners:function(){l.addEventListener("canplay",function(){p||(0<l.videoWidth&&(c=l.videoHeight/(l.videoWidth/d)),s[0].setAttribute("width",d),s[0].setAttribute("height",c),i.options.flipHorizontal&&(r.scale(-1,1),r.translate(-d,0)),i.options.flipVertical&&(r.scale(1,-1),r.translate(0,-c)),p=!0,(i.options.ReadQRCode||i.options.ReadBarecode)&&i.delay())},!1),l.addEventListener("play",function(){setInterval(function(){if(!l.paused&&!l.ended){r.clearRect(0,0,d,c);var e=i.options.zoom;0>e&&(e=i.optimalZoom()),r.drawImage(l,(d*e-d)/-2,(c*e-c)/-2,d*e,c*e),e=r.getImageData(0,0,d,c),i.options.grayScale&&(e=i.grayScale(e)),0==i.options.brightness&&0==i.options.autoBrightnessValue||(e=i.brightness(e,i.options.brightness)),0!=i.options.contrast&&(e=i.contrast(e,i.options.contrast)),0!=i.options.threshold&&(e=i.threshold(e,i.options.threshold)),0!=i.options.sharpness.length&&(e=i.convolute(e,i.options.sharpness)),r.putImageData(e,0,0)}},40)},!1)},setCallback:function(){g.onmessage=function(e){f||l.paused||(e.data.success&&1<e.data.result[0].length&&-1==e.data.result[0].indexOf("undefined")?(i.beep(),f=!0,i.delay(),i.options.resultFunction(e.data.result[0],n)):e.data.finished&&(h=!h,setTimeout(function(){i.tryParseBarecode()},320)))},qrcode.callback=function(e){f||l.paused||(i.beep(),f=!0,i.delay(),i.options.resultFunction(e,n))}},tryParseBarecode:function(){var e=1==h?"flip":"normal";n=s[0].toDataURL();var t=r.getImageData(0,0,d,c).data;g.postMessage({ImageData:t,Width:d,Height:c,cmd:e,DecodeNr:1,LowLight:!1})},tryParseQRCode:function(){try{n=s[0].toDataURL(),qrcode.decode()}catch(e){f||setTimeout(function(){i.tryParseQRCode()},320)}},delay:function(){i.cameraPlay(!0)},cameraStop:function(){f=!0,l.pause()},cameraStopAll:function(){r.clearRect(0,0,d,c),f=!0,l.pause();for(var e in u)u[e]&&(u[e].stop(),u[e]=null)},cameraPlay:function(e){u[i.options.videoSource.id]?e||i.cameraSuccess(u[i.options.videoSource.id]):i.init(),f=!0,l.play(),setTimeout(function(){f=!1,i.options.ReadBarecode&&i.tryParseBarecode(),i.options.ReadQRCode&&i.tryParseQRCode()},2e3)},getLastImageSrc:function(){return n},optimalZoom:function(){return l.videoHeight/c},getImageLightness:function(){for(var e,t,o,a=r.getImageData(0,0,d,c).data,i=0,n=0,s=a.length;s>n;n+=4)e=a[n],t=a[n+1],o=a[n+2],e=Math.floor((e+t+o)/3),i+=e;return Math.floor(i/(d*c))},brightness:function(e,t){t=0==t&&0!=i.options.autoBrightnessValue?i.options.autoBrightnessValue-i.getImageLightness():t;for(var o=e.data,a=0;a<o.length;a+=4)o[a]+=t,o[a+1]+=t,o[a+2]+=t;return e},grayScale:function(e){for(var t=e.data,o=0;o<t.length;o+=4)t[o]=t[o+1]=t[o+2]=.2126*t[o]+.7152*t[o+1]+.0722*t[o+2];return e},contrast:function(e,t){for(var o=e.data,a=0;a<o.length;a+=4){t=10;var i=Math.round((o[a]+o[a+1]+o[a+2])/3);i>127?(o[a]+=o[a]/i*t,o[a+1]+=o[a+1]/i*t,o[a+2]+=o[a+2]/i*t):(o[a]-=o[a]/i*t,o[a+1]-=o[a+1]/i*t,o[a+2]-=o[a+2]/i*t)}return e},threshold:function(e,t){for(var o,a=e.data,i=0,n=d*c*4;n>i;i+=4)o=a[i]+a[i+1]+a[i+2],a[i]=t>o?a[i+1]=a[i+2]=0:a[i+1]=a[i+2]=255,a[i+3]=255;return e},convolute:function(e,t,a){var i=e.width,n=e.height,r=Math.round(Math.sqrt(t.length)),s=Math.floor(r/2);e=e.data;var d=o.createElement("canvas").getContext("2d").createImageData(i,n),c=d.data;a=a?1:0;for(var u=0;n>u;u++)for(var l=0;i>l;l++){for(var h=u,p=l,g=0,f=0,m=0,v=0,y=4*(u*i+l),b=0;r>b;b++)for(var R=0;r>R;R++){var S=h+b-s,C=p+R-s;S>=0&&n>S&&C>=0&&i>C&&(S=4*(S*i+C),C=t[b*r+R],g+=e[S]*C,f+=e[S+1]*C,m+=e[S+2]*C,v+=e[S+3]*C)}c[y]=g,c[y+1]=f,c[y+2]=m,c[y+3]=v+a*(255-v)}return d},beep:function(){if("string"==typeof i.options.beep){var e=i.options.beep;setTimeout(function(){new Audio(e).play()},0)}}},e.fn.WebCodeCam=function(t){return this.each(function(){e.data(this,"plugin_WebCodeCam")||e.data(this,"plugin_WebCodeCam",new a(this,t))})}}(jQuery,window,document);