!function(t,e,o){"use strict";function a(e,o){this.element=e,s=t(e),this.options=t.extend({},m,o),this._defaults=m,this._name=v,this.init()&&(this.setEventListeners(),(this.options.ReadQRCode||this.options.ReadBarecode)&&this.setCallback())}var i,n,r,s,d,c,u={},l=t('<video style="position:absolute;visibility:hidden;display: none;">')[0],h=!1,p=!1,g=new Worker("js/DecoderWorker.js"),f=!1,v="WebCodeCam",m={ReadQRCode:!0,ReadBarecode:!0,width:320,height:240,videoSource:{id:!0,maxWidth:640,maxHeight:480},flipVertical:!1,flipHorizontal:!1,zoom:-1,beep:"https://rawgit.com/zalharbee/seawot/master/barcode/js/beep.mp3",brightness:0,autoBrightnessValue:!1,grayScale:!1,contrast:0,threshold:0,sharpness:[],resultFunction:function(){},getUserMediaError:function(){},cameraError:function(){}};a.prototype={init:function(){return i=this,r=i.element.getContext("2d"),d=i.options.width,c=i.options.height,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia?(u[i.options.videoSource.id]&&u[i.options.videoSource.id].active?i.cameraSuccess(u[i.options.videoSource.id]):navigator.getUserMedia({video:{mandatory:{maxWidth:i.options.videoSource.maxWidth,maxHeight:i.options.videoSource.maxHeight},optional:[{sourceId:i.options.videoSource.id}]},audio:!1},i.cameraSuccess,i.cameraError),!0):(i.options.getUserMediaError(),!1)},cameraSuccess:function(t){u[i.options.videoSource.id]=t;var o=e.URL||e.webkitURL;l.src=o?o.createObjectURL(t):t,l.play()},cameraError:function(t){return i.options.cameraError(t),!1},setEventListeners:function(){l.addEventListener("canplay",function(){p||(l.videoWidth>0&&(c=l.videoHeight/(l.videoWidth/d)),s[0].setAttribute("width",d),s[0].setAttribute("height",c),i.options.flipHorizontal&&(r.scale(-1,1),r.translate(-d,0)),i.options.flipVertical&&(r.scale(1,-1),r.translate(0,-c)),p=!0,(i.options.ReadQRCode||i.options.ReadBarecode)&&i.delay())},!1),l.addEventListener("play",function(){setInterval(function(){if(!l.paused&&!l.ended){r.clearRect(0,0,d,c);var t=i.options.zoom;0>t&&(t=i.optimalZoom()),r.drawImage(l,(d*t-d)/-2,(c*t-c)/-2,d*t,c*t);var e=r.getImageData(0,0,d,c);i.options.grayScale&&(e=i.grayScale(e)),0==i.options.brightness&&0==i.options.autoBrightnessValue||(e=i.brightness(e,i.options.brightness)),0!=i.options.contrast&&(e=i.contrast(e,i.options.contrast)),0!=i.options.threshold&&(e=i.threshold(e,i.options.threshold)),0!=i.options.sharpness.length&&(e=i.convolute(e,i.options.sharpness)),r.putImageData(e,0,0)}},40)},!1)},setCallback:function(){g.onmessage=function(t){f||l.paused||(t.data.success&&t.data.result[0].length>1&&-1==t.data.result[0].indexOf("undefined")?(i.beep(),f=!0,i.delay(),i.options.resultFunction(t.data.result[0],n)):t.data.finished&&(h=!h,setTimeout(function(){i.tryParseBarecode()},320)))},qrcode.callback=function(t){f||l.paused||(i.beep(),f=!0,i.delay(),i.options.resultFunction(t,n))}},tryParseBarecode:function(){var t=1==h?"flip":"normal";n=s[0].toDataURL();var e=r.getImageData(0,0,d,c).data;g.postMessage({ImageData:e,Width:d,Height:c,cmd:t,DecodeNr:1,LowLight:!1})},tryParseQRCode:function(){try{n=s[0].toDataURL(),qrcode.decode()}catch(t){f||setTimeout(function(){i.tryParseQRCode()},320)}},delay:function(){i.cameraPlay(!0)},cameraStop:function(){f=!0,l.pause()},cameraStopAll:function(){r.clearRect(0,0,d,c),f=!0,l.pause();for(var t in u)u[t]&&(u[t].stop(),u[t]=null)},cameraPlay:function(t){u[i.options.videoSource.id]?t||i.cameraSuccess(u[i.options.videoSource.id]):i.init(),f=!0,l.play(),setTimeout(function(){f=!1,i.options.ReadBarecode&&i.tryParseBarecode(),i.options.ReadQRCode&&i.tryParseQRCode()},2e3)},getLastImageSrc:function(){return n},optimalZoom:function(){return l.videoHeight/c},getImageLightness:function(){for(var t,e,o,a,i=r.getImageData(0,0,d,c),n=i.data,s=0,u=0,l=n.length;l>u;u+=4)t=n[u],e=n[u+1],o=n[u+2],a=Math.floor((t+e+o)/3),s+=a;return Math.floor(s/(d*c))},brightness:function(t,e){e=0==e&&0!=i.options.autoBrightnessValue?i.options.autoBrightnessValue-i.getImageLightness():e;for(var o=t.data,a=0;a<o.length;a+=4)o[a]+=e,o[a+1]+=e,o[a+2]+=e;return t},grayScale:function(t){for(var e=t.data,o=0;o<e.length;o+=4){var a=e[o],i=e[o+1],n=e[o+2],r=.2126*a+.7152*i+.0722*n;e[o]=e[o+1]=e[o+2]=r}return t},contrast:function(t,e){for(var o=t.data,a=0;a<o.length;a+=4){var e=10,i=Math.round((o[a]+o[a+1]+o[a+2])/3);i>127?(o[a]+=o[a]/i*e,o[a+1]+=o[a+1]/i*e,o[a+2]+=o[a+2]/i*e):(o[a]-=o[a]/i*e,o[a+1]-=o[a+1]/i*e,o[a+2]-=o[a+2]/i*e)}return t},threshold:function(t,e){for(var o,a=t.data,i=0,n=d*c*4;n>i;i+=4)o=a[i]+a[i+1]+a[i+2],e>o?a[i]=a[i+1]=a[i+2]=0:a[i]=a[i+1]=a[i+2]=255,a[i+3]=255;return t},convolute:function(t,e,a){for(var i=t.width,n=t.height,r=i,s=n,d=Math.round(Math.sqrt(e.length)),c=Math.floor(d/2),u=t.data,l=o.createElement("canvas"),h=l.getContext("2d"),p=h.createImageData(r,s),g=p.data,f=a?1:0,v=0;s>v;v++)for(var m=0;r>m;m++){for(var y=v,b=m,R=0,S=0,M=0,w=0,L=4*(v*r+m),U=0;d>U;U++)for(var C=0;d>C;C++){var I=y+U-c,B=b+C-c;if(I>=0&&n>I&&B>=0&&i>B){var E=4*(I*i+B),x=e[U*d+C];R+=u[E]*x,S+=u[E+1]*x,M+=u[E+2]*x,w+=u[E+3]*x}}g[L]=R,g[L+1]=S,g[L+2]=M,g[L+3]=w+f*(255-w)}return p},beep:function(){if("string"==typeof i.options.beep){var t=i.options.beep;setTimeout(function(){new Audio(t).play()},0)}}},t.fn[v]=function(e){return this.each(function(){t.data(this,"plugin_"+v)||t.data(this,"plugin_"+v,new a(this,e))})}}(jQuery,window,document);